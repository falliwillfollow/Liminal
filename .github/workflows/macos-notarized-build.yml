name: macOS Notarized Build

on:
  workflow_dispatch:

jobs:
  build-sign-notarize:
    runs-on: macos-14
    env:
      GODOT_VERSION: 4.6-stable
      EXPORT_TEMPLATES_VERSION: 4.6.stable
      APP_NAME: Liminal
      EXPORT_ZIP: build/Liminal-mac.zip
      APP_PATH: build/macos/Liminal.app
      DMG_PATH: build/Liminal-macOS-notarized.dmg
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Godot editor
        run: |
          curl -L "https://github.com/godotengine/godot-builds/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_macos.universal.zip" -o godot.zip
          unzip -q godot.zip
          mv "Godot.app/Contents/MacOS/Godot" ./godot
          chmod +x ./godot

      - name: Install export templates
        run: |
          mkdir -p "$HOME/Library/Application Support/Godot/export_templates/${EXPORT_TEMPLATES_VERSION}"
          curl -L "https://github.com/godotengine/godot-builds/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_export_templates.tpz" -o templates.tpz
          tar -xf templates.tpz -C "$HOME/Library/Application Support/Godot/export_templates/${EXPORT_TEMPLATES_VERSION}" templates/macos.zip templates/version.txt
          cp "$HOME/Library/Application Support/Godot/export_templates/${EXPORT_TEMPLATES_VERSION}/templates/macos.zip" "$HOME/Library/Application Support/Godot/export_templates/${EXPORT_TEMPLATES_VERSION}/macos.zip"
          cp "$HOME/Library/Application Support/Godot/export_templates/${EXPORT_TEMPLATES_VERSION}/templates/version.txt" "$HOME/Library/Application Support/Godot/export_templates/${EXPORT_TEMPLATES_VERSION}/version.txt"

      - name: Export macOS zip
        run: |
          mkdir -p build
          ./godot --headless --path . --export-release "macOS" "${EXPORT_ZIP}"

      - name: Unpack app bundle
        run: |
          mkdir -p build/macos
          ditto -x -k "${EXPORT_ZIP}" build/macos
          test -d "${APP_PATH}"

      - name: Import Developer ID certificate
        env:
          MACOS_CERT_BASE64: ${{ secrets.MACOS_DEVELOPER_ID_APP_CERT_BASE64 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_DEVELOPER_ID_APP_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.MACOS_TEMP_KEYCHAIN_PASSWORD }}
        run: |
          if [[ -z "${MACOS_CERT_BASE64}" || -z "${MACOS_CERT_PASSWORD}" || -z "${KEYCHAIN_PASSWORD}" ]]; then
            echo "Missing certificate secrets."
            exit 1
          fi
          echo "${MACOS_CERT_BASE64}" | base64 --decode > dev_id_app.p12
          security create-keychain -p "${KEYCHAIN_PASSWORD}" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" build.keychain
          security import dev_id_app.p12 -k build.keychain -P "${MACOS_CERT_PASSWORD}" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${KEYCHAIN_PASSWORD}" build.keychain
          security find-identity -v -p codesigning build.keychain

      - name: Sign app
        env:
          DEVELOPER_ID_APP_CERT: ${{ secrets.DEVELOPER_ID_APP_CERT }}
        run: |
          if [[ -z "${DEVELOPER_ID_APP_CERT}" ]]; then
            echo "Missing DEVELOPER_ID_APP_CERT secret."
            exit 1
          fi
          codesign --force --deep --options runtime --timestamp --sign "${DEVELOPER_ID_APP_CERT}" "${APP_PATH}"
          codesign --verify --deep --strict --verbose=2 "${APP_PATH}"

      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [[ -z "${APPLE_ID}" || -z "${APPLE_APP_SPECIFIC_PASSWORD}" || -z "${APPLE_TEAM_ID}" ]]; then
            echo "Missing notarization secrets."
            exit 1
          fi
          ditto -c -k --keepParent "${APP_PATH}" build/Liminal-notary.zip
          xcrun notarytool submit build/Liminal-notary.zip \
            --apple-id "${APPLE_ID}" \
            --password "${APPLE_APP_SPECIFIC_PASSWORD}" \
            --team-id "${APPLE_TEAM_ID}" \
            --wait
          xcrun stapler staple "${APP_PATH}"
          xcrun stapler validate "${APP_PATH}"

      - name: Build and notarize DMG
        env:
          DEVELOPER_ID_APP_CERT: ${{ secrets.DEVELOPER_ID_APP_CERT }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          hdiutil create -volname "${APP_NAME}" -srcfolder "${APP_PATH}" -ov -format UDZO "${DMG_PATH}"
          codesign --force --timestamp --sign "${DEVELOPER_ID_APP_CERT}" "${DMG_PATH}"
          xcrun notarytool submit "${DMG_PATH}" \
            --apple-id "${APPLE_ID}" \
            --password "${APPLE_APP_SPECIFIC_PASSWORD}" \
            --team-id "${APPLE_TEAM_ID}" \
            --wait
          xcrun stapler staple "${DMG_PATH}"
          spctl --assess --type open --verbose=2 "${DMG_PATH}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: liminal-macos-notarized
          path: |
            build/Liminal-mac.zip
            build/Liminal-macOS-notarized.dmg
